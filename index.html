<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ§ Nekohacker591 Portfolio</title>
  <meta name="title" content="ðŸŽ§ Nekohacker591 Portfolio" />
  <meta name="description" content="Welcome to Nekohacker's portfolio where I post my music to share with others without compression from platforms." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://nekohackers-music.onrender.com/" />
  <meta property="og:title" content="ðŸŽ§ Nekohacker591 Portfolio" />
  <meta property="og:description" content="Welcome to Nekohacker's portfolio where I post my music to share with others without compression from platforms." />
  <meta property="og:image" content="https://i.imgur.com/ClMFeop.png" />
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://nekohackers-music.onrender.com/" />
  <meta property="twitter:title" content="ðŸŽ§ Nekohacker591 Portfolio" />
  <meta property="twitter:description" content="Welcome to Nekohacker's portfolio where I post my music to share with others without compression from platforms." />
  <meta property="twitter:image" content="https://i.imgur.com/ClMFeop.png" />

  <style>
    :root {
      --primary-color: #007bff;
      --primary-color-hover: #0056b3;
      --background-color: #f8f9fa;
      --surface-color: #ffffff;
      --surface-highlight: #e9ecef;
      --text-color: #212529;
      --text-secondary-color: #6c757d;
      --border-radius: 8px;
      --transition-speed: 0.2s ease-in-out;
      --play-icon-url: "â–¶";
      --pause-icon-url: "â–®â–®";
      --download-icon-url: "â¬‡";
      --share-icon-url: "ðŸ”—";
      --mute-icon-url: "ðŸ”‡";
      --unmute-icon-url: "ðŸ”Š";
    }
    body {
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.6;
      box-sizing: border-box;
    }
    .site-header { width: 100%; max-width: 800px; margin-bottom: 20px; text-align: center; }
    h1 { color: var(--primary-color); margin-bottom: 10px; font-weight: 600; letter-spacing: 0.5px; }
    .global-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; color: var(--text-secondary-color); font-size: 14px; }
    .global-controls label { cursor: pointer; }
    .global-controls input[type="checkbox"] { accent-color: var(--primary-color); cursor: pointer; transform: scale(1.1); margin-right: 5px; }
    .tabs { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 2px solid var(--surface-highlight); }
    .tab-button { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 18px; font-weight: 500; color: var(--text-secondary-color); transition: color var(--transition-speed), border-bottom-color var(--transition-speed); border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .tab-button:hover { color: var(--primary-color); }
    .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; width: 100%; max-width: 700px; }
    .tab-content.active { display: block; }
    #home-content { padding: 15px; background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    #home-content p { margin-bottom: 1em; }
    .search-bar { margin-bottom: 20px; width: 100%; }
    .search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid var(--surface-highlight); border-radius: var(--border-radius); background-color: var(--surface-color); color: var(--text-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
    .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
    .search-input::placeholder { color: var(--text-secondary-color); }
    #song-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
    .song-item a { display: block; padding: 15px 20px; background-color: var(--surface-color); color: var(--text-color); text-decoration: none; border-radius: var(--border-radius); border: 1px solid var(--surface-highlight); transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed); font-size: 17px; }
    .song-item a:hover { background-color: var(--surface-highlight); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.07); color: var(--primary-color); }
    .song-item-empty { padding: 15px 20px; color: var(--text-secondary-color); text-align: center; }
    .player { background-color: var(--surface-color); padding: 25px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border: 1px solid var(--surface-highlight); transition: transform var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed); width: 100%; box-sizing: border-box; }
    .player.player-playing { border-color: var(--primary-color); box-shadow: 0 0 12px rgba(0, 123, 255, 0.25), 0 5px 15px rgba(0,0,0,0.1); }
    .track-title { font-size: 22px; margin-bottom: 18px; color: var(--text-color); font-weight: 500; text-align: center; }
    .controls { display: flex; align-items: center; gap: 15px; margin-bottom: 18px; }
    .play-btn { background-color: var(--primary-color); border: none; color: #fff; font-size: 22px; width: 52px; height: 52px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color var(--transition-speed), transform var(--transition-speed); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .play-btn:hover { background-color: var(--primary-color-hover); transform: scale(1.05); }
    .play-btn:active { transform: scale(0.98); }
    .progress-container { flex-grow: 1; display: flex; align-items: center; gap: 12px; }
    .progress { flex-grow: 1; height: 10px; background-color: var(--surface-highlight); border-radius: 5px; overflow: hidden; position: relative; cursor: pointer; }
    .progress-filled { height: 100%; background-color: var(--primary-color); width: 0; border-radius: 5px; transition: width 0.1s linear; }
    .current-time, .duration { font-size: 14px; color: var(--text-secondary-color); min-width: 42px; text-align: center; flex-shrink: 0; }
    .actions { margin-top: 18px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center; }
    .download-link, .share-btn { background-color: var(--surface-highlight); color: var(--text-secondary-color); padding: 10px 18px; border-radius: var(--border-radius); text-decoration: none; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color var(--transition-speed), color var(--transition-speed), transform var(--transition-speed); display: inline-flex; align-items: center; gap: 8px; }
    .download-link:hover, .share-btn:hover { background-color: var(--primary-color); color: #fff; transform: translateY(-1px); }
    .copied { opacity: 0; color: var(--primary-color); font-size: 13px; transition: opacity 0.3s var(--transition-speed); margin-left: 8px; }
    .copied.show { opacity: 1; }
    .volume-container { display: flex; align-items: center; gap: 12px; margin-top: 18px; }
    .mute-btn { background-color: transparent; border: 1px solid var(--text-secondary-color); color: var(--text-secondary-color); font-size: 20px; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed); }
    .mute-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
    .volume-slider { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--surface-highlight); outline: none; border-radius: 4px; cursor: pointer; transition: opacity var(--transition-speed); }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary-color); border-radius: 50%; cursor: pointer; border: 3px solid var(--surface-color); transition: background-color var(--transition-speed); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .volume-slider::-moz-range-thumb { width: 18px; height: 18px; background: var(--primary-color); border-radius: 50%; cursor: pointer; border: 3px solid var(--surface-color); transition: background-color var(--transition-speed); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .volume-slider:hover::-webkit-slider-thumb { background: var(--primary-color-hover); }
    .volume-slider:hover::-moz-range-thumb { background: var(--primary-color-hover); }
    .volume-slider:disabled { opacity: 0.6; cursor: default; }
    .volume-slider:disabled::-webkit-slider-thumb { background: var(--text-secondary-color); }
    .volume-slider:disabled::-moz-range-thumb { background: var(--text-secondary-color); }
    body.embed-mode { padding: 0; margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; background-color: var(--surface-color); }
    .player-embed { width: 100%; height: 100%; box-sizing: border-box; margin: 0; border-radius: 0; box-shadow: none; border: none; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
    .player-embed .track-title { font-size: 18px; margin-bottom: 12px; }
    .player-embed .controls { margin-bottom: 12px; }
    .player-embed .volume-container { margin-top: 12px; }
    .player-embed .actions { display: none; }
    @media (max-width: 680px) { body:not(.embed-mode) { padding: 10px; } h1 { font-size: 1.8em; } .tabs { margin-bottom: 15px;} .tab-button { padding: 10px 15px; font-size: 16px; } .player:not(.player-embed) { padding: 15px; } .track-title { font-size: 18px; } .controls { gap: 10px; margin-bottom: 12px; } .play-btn { width: 46px; height: 46px; font-size: 20px; } .current-time, .duration { font-size: 12px; min-width: 35px; } .actions, .volume-container { margin-top: 12px; } .download-link, .share-btn { padding: 8px 12px; font-size: 13px; } .mute-btn { width: 38px; height: 38px; font-size: 18px; } .volume-slider::-webkit-slider-thumb { width: 16px; height: 16px; border-width: 2px; } .volume-slider::-moz-range-thumb { width: 16px; height: 16px; border-width: 2px; } }
  </style>
</head>
<body>
  <div class="site-header">
    <h1>ðŸŽ§ Nekohacker591 Portfolio</h1>
    <div class="global-controls">
        <input type="checkbox" id="autoplay-next">
        <label for="autoplay-next">Autoplay Next</label>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button" data-tab="home">Home</button>
    <button class="tab-button" data-tab="music">Music</button>
  </div>

  <div id="home-content" class="tab-content">
    <h2>Welcome!</h2>
    <p>Hey there, welcome to my little corner of the internet! This is where I stash all my musical creations. I got tired of platforms squashing the life out of my audio, so I built this place to share my tracks in their full, uncompressed glory.</p>
    <p>Here you can:</p>
    <ul>
        <li>Browse my latest tunes in the "Music" tab.</li>
        <li>Listen to high-quality WAV files.</li>
        <li>Download anything you like.</li>
        <li>Share your favorites with your pals.</li>
    </ul>
    <p>Thanks for stopping by and having a listen. Hope you find something that makes your ears happy!</p>
    <p><em>- Nekohacker591</em></p>
  </div>

  <div id="music-content" class="tab-content">
    <div class="search-bar">
      <input type="text" id="music-search-input" class="search-input" placeholder="Search for a track...">
    </div>
    <ul id="song-list">
      <!-- Song items will be injected here by JavaScript -->
    </ul>
  </div>

  <div id="player-view-content" class="tab-content">
    <!-- Single player for ?view=player&songId=X will be injected here -->
  </div>

  <script>
    const globalPlayerState = {
        currentPlayingAudio: null,
        currentPlayingPlayerDiv: null,
        lastVolume: parseFloat(localStorage.getItem('nekohacker_globalVolume')) || 0.75,
        isMuted: JSON.parse(localStorage.getItem('nekohacker_isMuted')) || false,
        get autoplayNext() { return document.getElementById('autoplay-next')?.checked ?? true; },
        set autoplayNext(value) {
            const cb = document.getElementById('autoplay-next');
            if (cb) cb.checked = value;
            localStorage.setItem('nekohacker_autoplayNext', JSON.stringify(value));
        }
    };

    const songsData = [
      { title: "Rock and Roll", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/rock%20and%20roll%20mixed.wav?download=true", artwork: "https://i.imgur.com/ClMFeop.png" },
      { title: "Mesmerizer", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/vocoloid%20project%20v4.wav?download=true" },
      { title: "1 Track Chiptune", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/one%20track%20challenge.wav?download=true" },
      { title: "Eye of Horus", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/aoharutale%20eye%20of%20horus%20final%20mix.wav?download=true" },
      { title: "Eye of Horus Red Edition", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/Eye%20of%20H.O.R.U.S%20red%20edition%20MIX%20mix.wav?download=true" },
      { title: "You Will Know Our Names Recreation Attempt", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/Xenoblade%20Chronicles%20OST%20-%20You%20Will%20Know%20Our%20Names%20bootleg.wav?download=true" },
      { title: "Chill Synth Wave", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/chill%20song%20mixed.wav?download=true" },
      { title: "The Video Game Melody 2025 Edition", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/video%20game%20melody.wav?download=true" },
      { title: "Elyisan", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/idol%20song%202.wav?download=true" },
      { title: "Bang Dream", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/bang%20dream.wav?download=true" },
      { title: "Red Zone Remix", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/red%20zone%20serum%202%20evaluation%20super%20massive.wav?download=true" },
      { title: "Nee Nee Nee", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/nee%20nee%20nee%20final%20ozone%20edition.wav?download=true" },
      { title: "Circulation", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/circulation.wav?download=true" },
      { title: "Flowering Night Remix", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/flowering%20night.wav?download=true" },
      { title: "The Video Game Melody 2024 Edition ", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/mario%20melody.wav?download=true" },
      { title: "8 Bit Magic", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/8%20bit%20magic.wav?download=true" },
      { title: "Akuno Meshitsukai", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/akuno_meshitsukai%20premaster.wav?download=true" },
      { title: "Luminous Neko", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/anime%20op%202%20like%20song%20group%20master.wav?download=true" },
      { title: "Nekos's Bon AppÃ©titâ™¡", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/anime%20op%20after%20mastering.wav?download=true" },
      { title: "Do-Dai Neko Joy", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/do-dai%20neko%20joy%20remix%20trail%20test.wav?download=true" },
      { title: "Neko No Yorokobi", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/Neko%20no%20yorokobi.wav?download=true" },
      { title: "Save The World", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/good%20remix%20rock%20sprit%20rock.wav?download=true" },
      { title: "The Joker", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/joker%20game%20song.wav?download=true" },
      { title: "Ely Dreamy", file: "https://huggingface.co/datasets/nekohacker591/music/resolve/main/mus/Ely%20Dreamy.wav?download=true" }
    ];
    const defaultArtwork = 'https://i.imgur.com/ClMFeop.png';

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const songListUl = document.getElementById('song-list');
    const musicSearchInput = document.getElementById('music-search-input');
    const autoplayCheckbox = document.getElementById('autoplay-next');
    const playerViewContainer = document.getElementById('player-view-content');
    const siteHeader = document.querySelector('.site-header');
    const tabsContainer = document.querySelector('.tabs');
    const homeContent = document.getElementById('home-content');
    const musicContent = document.getElementById('music-content');


    function formatTime(seconds) {
      if (isNaN(seconds) || seconds === Infinity) return '--:--';
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function createPlayerElement(track, index, isEmbedStyle = false) {
        const playerDiv = document.createElement("div");
        playerDiv.className = "player";
        if (isEmbedStyle) playerDiv.classList.add("player-embed");
        playerDiv.id = `player-${index}`;
        playerDiv.dataset.src = track.file;
        playerDiv.dataset.index = index;

        const playIconText = getComputedStyle(document.documentElement).getPropertyValue('--play-icon-url').trim() || 'â–¶';
        const downloadIconText = getComputedStyle(document.documentElement).getPropertyValue('--download-icon-url').trim() || 'â¬‡';
        const shareIconText = getComputedStyle(document.documentElement).getPropertyValue('--share-icon-url').trim() || 'ðŸ”—';
        const muteIconText = getComputedStyle(document.documentElement).getPropertyValue('--mute-icon-url').trim() || 'ðŸ”‡';

        const actionsHTML = `
            <a class="download-link" href="${track.file}" download="${track.title.replace(/[^\w\s.-]/g, '') || 'track'}.wav">
                ${downloadIconText} Download
            </a>
            <button class="share-btn">
                ${shareIconText} Share
            </button>
            <span class="copied">Copied!</span>
        `;

        playerDiv.innerHTML = `
            <div class="track-title">${track.title}</div>
            <div class="controls">
                <button class="play-btn">${playIconText}</button>
                <div class="progress-container">
                    <span class="current-time">0:00</span>
                    <div class="progress"><div class="progress-filled"></div></div>
                    <span class="duration">--:--</span>
                </div>
            </div>
            ${!isEmbedStyle ? `<div class="actions">${actionsHTML}</div>` : ''}
            <div class="volume-container">
                <button class="mute-btn">${muteIconText}</button>
                <input type="range" class="volume-slider" min="0" max="1" step="0.01" value="${globalPlayerState.lastVolume}">
            </div>
        `;

        if (!isEmbedStyle) {
            const shareBtn = playerDiv.querySelector('.share-btn');
            const copiedMsg = playerDiv.querySelector('.copied');
            if (shareBtn && copiedMsg) {
                shareBtn.addEventListener('click', () => {
                    const playerViewUrl = new URL(window.location.origin + window.location.pathname);
                    playerViewUrl.searchParams.set('view', 'player');
                    playerViewUrl.searchParams.set('songId', index.toString());
                    
                    navigator.clipboard.writeText(playerViewUrl.href).then(() => {
                        copiedMsg.classList.add('show');
                        setTimeout(() => copiedMsg.classList.remove('show'), 1500);
                    }).catch(err => console.error('Failed to copy share link:', err));
                });
            }
        }
        return playerDiv;
    }

    function initializeAudioForPlayer(playerDiv, autoPlay = false) {
      if (playerDiv.audioInitialized && playerDiv.audio) { // Check if audio exists, might be cleared
          if (playerDiv.audio.src === playerDiv.dataset.src && !autoPlay) return; // Already init for this src, no autoplay
      }

      // If re-initializing, ensure old audio is cleaned up if it exists on the div
      if (playerDiv.audio) {
          playerDiv.audio.pause();
          playerDiv.audio.src = ""; // Release resource
          // Remove old event listeners if any were manually added and not auto-cleaned
      }
      
      const audio = new Audio();
      audio.preload = "metadata";
      playerDiv.audio = audio;
      playerDiv.audioInitialized = true; // Mark as initialized

      const playBtn = playerDiv.querySelector('.play-btn');
      const progressFilled = playerDiv.querySelector('.progress-filled');
      const progressBar = playerDiv.querySelector('.progress');
      const volumeSlider = playerDiv.querySelector('.volume-slider');
      const muteBtn = playerDiv.querySelector('.mute-btn');
      const currentTimeDisplay = playerDiv.querySelector('.current-time');
      const durationDisplay = playerDiv.querySelector('.duration');
      const trackTitleElement = playerDiv.querySelector('.track-title');
      const songIndex = parseInt(playerDiv.dataset.index);

      const playIcon = getComputedStyle(document.documentElement).getPropertyValue('--play-icon-url').trim() || 'â–¶';
      const pauseIcon = getComputedStyle(document.documentElement).getPropertyValue('--pause-icon-url').trim() || 'â–®â–®';
      const muteIcon = getComputedStyle(document.documentElement).getPropertyValue('--mute-icon-url').trim() || 'ðŸ”‡';
      const unmuteIcon = getComputedStyle(document.documentElement).getPropertyValue('--unmute-icon-url').trim() || 'ðŸ”Š';

      audio.muted = globalPlayerState.isMuted;
      audio.volume = globalPlayerState.lastVolume;
      volumeSlider.value = globalPlayerState.lastVolume;
      muteBtn.textContent = globalPlayerState.isMuted ? unmuteIcon : muteIcon;
      volumeSlider.disabled = globalPlayerState.isMuted;

      audio.addEventListener('loadedmetadata', () => {
        durationDisplay.textContent = formatTime(audio.duration);
        if (autoPlay && playerDiv.shouldAutoPlay !== false) {
            audio.play().catch(e => console.warn("Autoplay prevented:", e));
        }
      });
      audio.addEventListener('play', () => {
        playBtn.textContent = pauseIcon;
        playerDiv.classList.add('player-playing');
        globalPlayerState.currentPlayingAudio = audio;
        globalPlayerState.currentPlayingPlayerDiv = playerDiv;
        if (trackTitleElement) document.title = `ðŸŽ§ ${trackTitleElement.textContent} - Nekohacker591`;
      });
      audio.addEventListener('pause', () => {
        playBtn.textContent = playIcon;
        playerDiv.classList.remove('player-playing');
        // Don't nullify global state here if pause is temporary
        // Only reset title if truly stopped, not just paused by another play action
        if (globalPlayerState.currentPlayingAudio === audio && audio.ended) { // or some other "final stop" condition
             document.title = 'ðŸŽ§ Nekohacker591 Portfolio';
        }
      });
      audio.addEventListener('timeupdate', () => {
        if (audio.duration) {
          const percent = (audio.currentTime / audio.duration) * 100;
          progressFilled.style.width = percent + '%';
        }
        currentTimeDisplay.textContent = formatTime(audio.currentTime);
      });
      audio.addEventListener('ended', () => {
        playBtn.textContent = playIcon;
        progressFilled.style.width = '0%';
        currentTimeDisplay.textContent = formatTime(0);
        playerDiv.classList.remove('player-playing');
        document.title = 'ðŸŽ§ Nekohacker591 Portfolio';

        if (globalPlayerState.currentPlayingPlayerDiv === playerDiv) {
            globalPlayerState.currentPlayingAudio = null;
            globalPlayerState.currentPlayingPlayerDiv = null;
        }
        if (globalPlayerState.autoplayNext) {
            const currentView = new URLSearchParams(window.location.search).get('view');
            if (currentView === 'player' && songIndex < songsData.length - 1) {
                navigateToPlayerView(songIndex + 1);
            }
        }
      });
      audio.addEventListener('volumechange', () => {
        muteBtn.textContent = (audio.muted || audio.volume === 0) ? unmuteIcon : muteIcon;
        volumeSlider.disabled = audio.muted;
        if (!audio.muted) {
          volumeSlider.value = audio.volume;
          globalPlayerState.lastVolume = audio.volume;
        }
        globalPlayerState.isMuted = audio.muted;
        localStorage.setItem('nekohacker_globalVolume', globalPlayerState.lastVolume.toString());
        localStorage.setItem('nekohacker_isMuted', JSON.stringify(globalPlayerState.isMuted));
      });
      volumeSlider.addEventListener('input', () => {
        audio.muted = false;
        audio.volume = parseFloat(volumeSlider.value);
      });
      muteBtn.addEventListener('click', () => { audio.muted = !audio.muted; });
      playBtn.addEventListener('click', () => {
        if (!audio.src || audio.src !== playerDiv.dataset.src) audio.src = playerDiv.dataset.src;

        if (audio.paused) {
          if (globalPlayerState.currentPlayingAudio && globalPlayerState.currentPlayingAudio !== audio) {
            globalPlayerState.currentPlayingAudio.pause();
            if(globalPlayerState.currentPlayingPlayerDiv) {
                globalPlayerState.currentPlayingPlayerDiv.querySelector('.play-btn').textContent = playIcon;
                globalPlayerState.currentPlayingPlayerDiv.classList.remove('player-playing');
            }
          }
          audio.play().catch(e => console.error("Play failed:", e));
        } else {
          audio.pause();
        }
      });
      progressBar.addEventListener('click', (e) => {
        if (!audio.duration || audio.duration === Infinity) return;
        const rect = progressBar.getBoundingClientRect();
        const newTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
        audio.currentTime = newTime;
        if (audio.paused) {
          progressFilled.style.width = ((newTime / audio.duration) * 100) + '%';
          currentTimeDisplay.textContent = formatTime(newTime);
        }
      });
      if (!audio.src && playerDiv.dataset.src) {
          audio.src = playerDiv.dataset.src;
      }
    }
    
    function setMetaTags(options = {}) {
        const defaults = {
            title: 'ðŸŽ§ Nekohacker591 Portfolio',
            description: 'Welcome to Nekohacker\'s portfolio where I post my music to share with others without compression from platforms.',
            url: window.location.origin + window.location.pathname,
            type: 'website',
            imageUrl: defaultArtwork,
            audioUrl: null,
            trackIdForEmbed: null,
            twitterCardType: 'summary_large_image'
        };
        const config = { ...defaults, ...options };
        document.title = config.title;
        const head = document.head;
        head.querySelectorAll('meta[data-dynamic-meta]').forEach(tag => tag.remove());
        const tagsToSet = [
            { property: 'og:title', content: config.title }, { property: 'og:description', content: config.description },
            { property: 'og:url', content: config.url }, { property: 'og:type', content: config.type },
            { property: 'og:image', content: config.imageUrl }, { name: 'twitter:card', content: config.twitterCardType },
            { name: 'twitter:title', content: config.title }, { name: 'twitter:description', content: config.description },
            { name: 'twitter:image', content: config.imageUrl },
        ];
        if (config.audioUrl) {
            tagsToSet.push({ property: 'og:audio', content: config.audioUrl });
            tagsToSet.push({ property: 'og:audio:type', content: 'audio/wav' });
        }
        if (config.trackIdForEmbed !== null && songsData[config.trackIdForEmbed]) {
            const embedUrl = new URL(window.location.origin + window.location.pathname);
            embedUrl.searchParams.set('embed', config.trackIdForEmbed.toString());
            tagsToSet.push({ name: 'twitter:player', content: embedUrl.href });
            tagsToSet.push({ name: 'twitter:player:width', content: '500' });
            tagsToSet.push({ name: 'twitter:player:height', content: '180' });
            const twitterCardIndex = tagsToSet.findIndex(tag => tag.name === 'twitter:card');
            if (twitterCardIndex > -1) tagsToSet[twitterCardIndex].content = 'player';
            else tagsToSet.push({ name: 'twitter:card', content: 'player' });
        }
        tagsToSet.forEach(tagInfo => {
            const meta = document.createElement('meta');
            meta.setAttribute('data-dynamic-meta', 'true');
            if (tagInfo.property) meta.setAttribute('property', tagInfo.property);
            if (tagInfo.name) meta.setAttribute('name', tagInfo.name);
            meta.setAttribute('content', tagInfo.content);
            head.appendChild(meta);
        });
    }

    function populateSongList(filteredSongs = songsData) {
      songListUl.innerHTML = '';
      if (filteredSongs.length === 0 && musicSearchInput.value !== '') {
          songListUl.innerHTML = '<li class="song-item-empty">No tracks match your search, chief.</li>';
          return;
      }
      filteredSongs.forEach((track) => {
        const actualIndex = songsData.findIndex(s => s.file === track.file);
        if (actualIndex === -1) return; // Should not happen if filteredSongs comes from songsData

        const li = document.createElement('li');
        li.className = 'song-item';
        const link = document.createElement('a');
        link.href = `?view=player&songId=${actualIndex}`;
        link.textContent = track.title;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          navigateToPlayerView(actualIndex);
        });
        li.appendChild(link);
        songListUl.appendChild(li);
      });
    }

    function navigateToPlayerView(songId) {
        const url = new URL(window.location);
        url.searchParams.set('view', 'player');
        url.searchParams.set('songId', songId.toString());
        url.searchParams.delete('s');
        url.searchParams.delete('id');
        url.searchParams.delete('share');
        window.history.pushState({ view: 'player', songId: songId }, '', url);
        renderView();
    }

    function renderView() {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view');
        const songIdParam = urlParams.get('songId');
        const embedIdParam = urlParams.get('embed');
        const legacyShareIdParam = urlParams.get('id');
        const isLegacyShareMode = urlParams.get('share') === 'true';
        const searchQuery = urlParams.get('s');

        if (globalPlayerState.currentPlayingAudio) {
            globalPlayerState.currentPlayingAudio.pause();
            if (globalPlayerState.currentPlayingPlayerDiv) {
                 const playBtn = globalPlayerState.currentPlayingPlayerDiv.querySelector('.play-btn');
                 if(playBtn) playBtn.textContent = getComputedStyle(document.documentElement).getPropertyValue('--play-icon-url').trim() || 'â–¶';
                 globalPlayerState.currentPlayingPlayerDiv.classList.remove('player-playing');
            }
            // Don't nullify immediately, only if truly switching context or song ends.
            // globalPlayerState.currentPlayingAudio = null;
            // globalPlayerState.currentPlayingPlayerDiv = null;
        }
        // document.title = 'ðŸŽ§ Nekohacker591 Portfolio'; // Reset title (or set specifically later)

        if (embedIdParam !== null && songsData[embedIdParam]) {
            document.body.innerHTML = '';
            document.body.className = 'embed-mode';
            const track = songsData[embedIdParam];
            const playerDiv = createPlayerElement(track, parseInt(embedIdParam), true);
            document.body.appendChild(playerDiv);
            playerDiv.shouldAutoPlay = true;
            initializeAudioForPlayer(playerDiv, true);
            return;
        }
        document.body.classList.remove('embed-mode');

        if (isLegacyShareMode && legacyShareIdParam !== null && songsData[legacyShareIdParam]) {
            navigateToPlayerView(parseInt(legacyShareIdParam));
            return;
        }

        tabContents.forEach(tc => tc.classList.remove('active'));
        tabButtons.forEach(button => button.classList.remove('active'));
        playerViewContainer.innerHTML = ''; // Clear previous player if any

        if (view === 'player' && songIdParam !== null && songsData[songIdParam]) {
            siteHeader.style.display = 'block'; 
            tabsContainer.style.display = 'none';
            playerViewContainer.classList.add('active'); // Make player view container visible

            const songId = parseInt(songIdParam);
            const track = songsData[songId];
            const playerDiv = createPlayerElement(track, songId, false);
            playerViewContainer.appendChild(playerDiv);
            playerDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            playerDiv.shouldAutoPlay = true;
            initializeAudioForPlayer(playerDiv, true);

            setMetaTags({
                title: `ðŸŽ§ ${track.title} - Nekohacker591`,
                description: `Listen to "${track.title}" by Nekohacker591.`,
                url: window.location.href, type: 'music.song', audioUrl: track.file,
                imageUrl: track.artwork || defaultArtwork, trackIdForEmbed: songId,
            });
        } else if (view === 'music') {
            siteHeader.style.display = 'block';
            tabsContainer.style.display = 'flex';
            musicContent.classList.add('active');
            document.querySelector('.tab-button[data-tab="music"]').classList.add('active');
            
            if (searchQuery) {
                musicSearchInput.value = searchQuery.replace(/\+/g, ' ');
                const filtered = songsData.filter(track => track.title.toLowerCase().includes(searchQuery.toLowerCase()));
                populateSongList(filtered);
            } else {
                musicSearchInput.value = ''; // Clear search input if no query
                populateSongList();
            }
            setMetaTags({ title: 'Music - Nekohacker591 Portfolio' });
        } else { // Default to Home Tab (view is null or 'home')
            siteHeader.style.display = 'block';
            tabsContainer.style.display = 'flex';
            homeContent.classList.add('active');
            document.querySelector('.tab-button[data-tab="home"]').classList.add('active');
            setMetaTags();
        }
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTabId = button.dataset.tab;
        const url = new URL(window.location);
        const currentParams = new URLSearchParams(url.search);
        const currentView = currentParams.get('view') || 'home'; // Default to home if no view
        
        // If clicking the already active tab, do nothing
        if (targetTabId === currentView && currentView !== 'player') { // player view is handled by song links
            return;
        }

        if (targetTabId === 'home') {
            url.searchParams.delete('view');
            url.searchParams.delete('s');
            url.searchParams.delete('songId');
        } else { // music tab
            url.searchParams.set('view', targetTabId);
            url.searchParams.delete('songId');
            // Keep 's' if navigating to music tab and it exists
        }
        window.history.pushState({ view: targetTabId }, '', url);
        renderView();
      });
    });

    if (musicSearchInput) {
        musicSearchInput.addEventListener('input', () => {
            const query = musicSearchInput.value.toLowerCase();
            const filteredSongs = songsData.filter(track => track.title.toLowerCase().includes(query));
            populateSongList(filteredSongs);
            const url = new URL(window.location);
            if (query) url.searchParams.set('s', query.replace(/ /g, '+'));
            else url.searchParams.delete('s');
            if (document.getElementById('music-content').classList.contains('active')) {
                 window.history.replaceState({ view: 'music', s: query }, '', url);
            }
        });
    }
    if (autoplayCheckbox) {
        const storedAutoplay = localStorage.getItem('nekohacker_autoplayNext');
        autoplayCheckbox.checked = storedAutoplay !== null ? JSON.parse(storedAutoplay) : true;
        globalPlayerState.autoplayNext = autoplayCheckbox.checked;
        autoplayCheckbox.addEventListener('change', (e) => {
            globalPlayerState.autoplayNext = e.target.checked;
        });
    }
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        let activeAudio = globalPlayerState.currentPlayingAudio;
        let activePlayerDiv = globalPlayerState.currentPlayingPlayerDiv;
        if (!activeAudio && playerViewContainer.classList.contains('active')) {
            activePlayerDiv = playerViewContainer.querySelector('.player');
            if (activePlayerDiv && activePlayerDiv.audio) activeAudio = activePlayerDiv.audio;
        }
        if (e.code === 'Space') { e.preventDefault(); if (activePlayerDiv) activePlayerDiv.querySelector('.play-btn')?.click(); }
        else if (e.code === 'KeyM') { e.preventDefault(); if (activePlayerDiv) activePlayerDiv.querySelector('.mute-btn')?.click(); }
        else if (activeAudio && activePlayerDiv) {
            let handled = false; const cT = activeAudio.currentTime, dur = activeAudio.duration, vol = activeAudio.volume;
            if (e.code==='ArrowLeft'){if(dur&&dur!==Infinity)activeAudio.currentTime=Math.max(0,cT-5);handled=true;}
            else if (e.code==='ArrowRight'){if(dur&&dur!==Infinity)activeAudio.currentTime=Math.min(dur,cT+5);handled=true;}
            else if (e.code==='ArrowUp'){activeAudio.muted=false;activeAudio.volume=Math.min(1,vol+0.05);handled=true;}
            else if (e.code==='ArrowDown'){activeAudio.muted=false;activeAudio.volume=Math.max(0,vol-0.05);handled=true;}
            if(handled)e.preventDefault();
        }
    });
    window.addEventListener('popstate', (event) => { renderView(); });
    document.addEventListener('DOMContentLoaded', () => { renderView(); });
  </script>
</body>
</html>
